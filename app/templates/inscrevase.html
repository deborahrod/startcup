<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
    crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <!-- jQuery primeiro -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/imask"></script>
<title>CriptoRace v3 - Inscrição de candidato</title>
<style>
  html,body{
    height:100%;
    margin:0;
    background:#000;
    overflow:hidden;
    font-family:"Courier New", Courier, monospace;
  }
  canvas#matrix{
    display:block;
    position:fixed;
    top:0;left:0;
    width:100vw;height:100vh;
    background:black;
      z-index: 0;
  }
  .credits{
    position:fixed;
    left:12px;bottom:12px;
    color:#0f0;opacity:0.55;
    font-size:12px;
  }
  .container-topo{
      position: relative;
      z-index: 10;
  }
  .porta-logo{
      width: 90%;
      height: 50%;
      overflow: hidden;
      margin: auto;
  }
  .porta-logo img{
      width: 100%;
      height: auto;
  }
  .porta-botoes button{
      margin-bottom: 50px;
  }
  form label{
      color:red;
  }
  h3{
      color: lawngreen;
  }
  #entraJogo{
      visibility: hidden;
      display: none;
  }
</style>
</head>
<body>

<canvas id="matrix"></canvas>
<div class="credits">CriptoRace V3 - Quase nenhum direito reservado!</div>

<div class="container container-topo">
    <div class="porta-logo">
        <img src="../static/logo1.png" />
    </div>
    <h3>Cadastro de candidato</h3>
    <form id="formCandidato">
      <div class="form-group">
        <label for="nome">Nome</label>
        <input type="text" class="form-control" id="nome" >
      </div>
      <div class="form-group">
        <label for="nick">Nick</label>
        <input type="text" class="form-control" id="nick">
        <div id="mensagem"></div>
      </div>
        <div class="form-group">
        <label for="telefone">Telefone</label>
        <input type="text" class="form-control" id="telefone">
      </div>
      <button type="submit" id="submitForm" class="btn btn-primary btn-block" disabled>Salvar cadastro</button>
      <button type="button" class="btn btn-outline-danger btn-lg btn-block" onclick="vaiParaAHome()">Voltar à home</button>

    </form>
    <div id="mensagem2"></div>
    <div id="entraJogo">
        <button type="button" class="btn btn-outline-danger btn-lg btn-block" onclick="vaiParaOJogo('serahoutradica?')">Entrar na competição</button>
        <button type="button" class="btn btn-outline-danger btn-lg btn-block" onclick="vaiParaAHome()">Voltar à home</button>
        <button type="button" class="btn btn-outline-danger btn-lg btn-block" onclick="vaiVerORanking()">Ver o ranking</button>
    </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('matrix');
  const ctx = canvas.getContext('2d');

  // parâmetros fixos
  const speedMultiplier = 2.5;
  const densityMultiplier = 3.0;
  const globalAlpha = 0.8;
  let paused = false;

  const charset = (
    'アイウエオカキクケコサシスセソタチツテトナニヌネノ' +
    '持つか持たないかが問題だ' +
    'ABCDEFGHIJKLMNOPQRSTUVWXYZ' +
    'abcdefghijklmnopqrstuvwxyz' +
    'Nensagens secretas CriptoRace' +
    '0123456789#666' +
    '!@#$%^&*()_+-=[]{}|;:,.<>/?'
  );

  let columns = [];
  let columnHeights = [];
  let fontSize = 18;

  function resize(){
    const DPR = window.devicePixelRatio || 1;
    canvas.width = Math.floor(window.innerWidth * DPR);
    canvas.height = Math.floor(window.innerHeight * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
    setupColumns();
  }
  window.addEventListener('resize', resize);

  function setupColumns(){
    const vw = Math.max(window.innerWidth,320);
    fontSize = Math.max(12, Math.round(vw / 80));
    ctx.font = fontSize + 'px monospace';
    const cols = Math.floor(window.innerWidth / fontSize);
    const effectiveCols = Math.max(2, Math.floor(cols * densityMultiplier));
    columns = new Array(effectiveCols);
    columnHeights = new Array(effectiveCols);
    for(let i=0;i<effectiveCols;i++){
      columns[i] = i * fontSize;
      columnHeights[i] = Math.floor(Math.random() * canvas.height / fontSize);
    }
  }

  const randChar = () => charset.charAt(Math.floor(Math.random() * charset.length));
  const greenColor = b => {
    const r = Math.floor(20 * (1 - b));
    const g = Math.floor(180 + 75 * b);
    const bl = Math.floor(20 * (1 - b));
    return `rgb(${r},${g},${bl})`;
  };

  let lastTime = 0;
  function step(time){
    if(!lastTime) lastTime = time;
    const dt = (time - lastTime)/1000;
    lastTime = time;
    if(!paused){
      ctx.fillStyle = `rgba(0,0,0,${0.08 / Math.max(0.08, globalAlpha)})`;
      ctx.fillRect(0,0,canvas.width,canvas.height);
      for(let i=0;i<columns.length;i++){
        const x = columns[i];
        const yLines = columnHeights[i];
        const yPx = yLines * fontSize;

        ctx.fillStyle = greenColor(1.0);
        ctx.globalAlpha = Math.min(1,globalAlpha);
        ctx.fillText(randChar(), x+2, yPx);

        const trailLen = 4;
        for(let t=1;t<=trailLen;t++){
          const yy = yPx - t*fontSize;
          if(yy<0) break;
          const bright = Math.max(0.15,1 - (t/(trailLen+1)));
          ctx.fillStyle = greenColor(bright);
          ctx.globalAlpha = Math.max(0.06, globalAlpha*(0.35*bright));
          ctx.fillText(randChar(), x+2, yy);
        }

        const baseSpeed = 5;
        const variance = (Math.random()*2 -1)*0.5;
        const deltaLines = (baseSpeed + variance) * speedMultiplier * dt;
        columnHeights[i] = yLines + deltaLines;
        if(columnHeights[i]*fontSize > canvas.height + 50 + Math.random()*500)
          columnHeights[i] = Math.random()*-30;
      }
      ctx.globalAlpha = 1.0;
    }
    requestAnimationFrame(step);
  }

  resize();
  ctx.fillStyle = 'black';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  requestAnimationFrame(step);

  // pausa automática se guia ficar oculta
  document.addEventListener('visibilitychange', () => {
    paused = document.hidden;
  });
})();
</script>
<script>
    $(document).ready(function () {
        //checando se o cabra já não tem dados na sessão, indicando que já está cadastrado
        if (localStorage.getItem('candidato')) {
            const candidatoSessao = JSON.parse(localStorage.getItem('candidato'));
            //alert(candidatoSessao.idCandidato);
            $("#formCandidato").hide(); // esconde
            $("#formCandidato").css({
                        "visibility": "hidden",
                        "display": "none"
                    });
            $("#entraJogo").css({
                "visibility": "visible",
                "display": "block"
            });
            $("#mensagem2").html('<div class="alert alert-success">Candidato já está cadastrado: '+candidatoSessao.nomeCompleto+' - ' + candidatoSessao.nick+'</div>');
          }
        $("#nick").on("blur", function (event) {
            event.preventDefault();

            let candidato = {
                nick: $("#nick").val().trim()
            };
            if ($("#nick").val().trim() === ""){
                $("#mensagem").html('<div class="alert alert-warning">Informe um nick!</div>');
            }else {
                console.log("Enviando candidato:", candidato);
                $("#mensagem").html('<div class="alert alert-warning">Checando nick</div>');
                checaNick(candidato);
            }
        });
        $("#nick").on("focus", function (event){
            $("#submitForm").prop("disabled", true);
            $("#mensagem").html('');
        });

        $("#formCandidato").on("submit", function (event) {
            event.preventDefault();

            let candidato = {
                nome: $("#nome").val().trim(),
                nick: $("#nick").val().trim(),
                matricula: $("#telefone").val().trim(),
                chave: $("#telefone").val().trim()
            };

            console.log("Enviando candidato:", candidato);
            cadastra(candidato);
            return false;
        });
    });
    function checaNick(candidato) {
        $.ajax({
            url: "/candidatos/buscar",
            type: "POST",
            contentType: "application/json",  // enviando JSON
            dataType: "json",                 // esperando JSON
            data: JSON.stringify(candidato),
            success: function (response) {
                console.log("Resposta da API:", response);
                $("#mensagem").html('');
                // Verifica se veio algum candidato
                if (Array.isArray(response) && response.length > 0) {
                    $("#mensagem").html('<div class="alert alert-warning">Nick já está em uso. Pense noutro! <br>Mas atenção, se você já fez o cadastro anteriormente, basta entrar (volte à home).</div>');
                } else {
                    $("#submitForm").prop("disabled", false);
                }
            },
            error: function (xhr) {
                console.error("Erro:", xhr);

                let erroMsg = "Erro ao buscar candidato.";
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    erroMsg = xhr.responseJSON.message;
                }

                $("#mensagem").html('<div class="alert alert-danger">' + erroMsg + '</div>');
            }
        });
    }


    function cadastra(candidato) {
        $("#mensagem2").html('');
        $.ajax({
            url: "/candidatos/",
            type: "POST",
            contentType: "application/json",  // enviando JSON
            dataType: "json",                 // esperando JSON
            data: JSON.stringify(candidato),
            success: function (response) {
                $('#formCandidato').hide();
                console.log("Resposta da API:", response);
                $("#mensagem").html('');
                // Verifica se veio algum candidato
                if (response && response.idCandidato && response.chave) {
                    $("#mensagem2").html('<div class="alert alert-success">Cadastro realizado com sucesso!</div>');
                    $("#submitForm").prop("disabled", true);
                    $("#formCandidato").hide(); // esconde
                    $("#entraJogo").css({
                        "visibility": "visible",
                        "display": "block"
                    });
                    localStorage.setItem('candidato', JSON.stringify(response));
                } else {
                    $("#mensagem2").html('<div class="alert alert-alert">Cadastro não foi efetuado. Procure o oráculo!</div>');
                }
            },
            error: function (xhr) {
                console.error("Erro:", xhr);

                let erroMsg = "Erro ao Cadastrar candidato.";
                if (xhr.responseJSON && xhr.responseJSON.erro) {
                    erroMsg = erroMsg +  xhr.responseJSON.erro;
                }
                $("#mensagem2").html('<div class="alert alert-danger">' + erroMsg + '</div>');
            }
        });
    }
    function vaiParaOJogo(agoranaoeh){
        //window.location.href = 'inscrevase.html';
        window.location.href = "{{ url_for('frontend.competir') }}";
    }
    function vaiParaAHome(){
        window.location.href = "{{ url_for('frontend.index') }}";
    }
    function vaiVerORanking(){
        window.location.href = "{{ url_for('frontend.ranking') }}";
    }

</script>
<script>
var element = document.getElementById('telefone');
var maskOptions = {
  mask: '(00) 00000-0000'
};
IMask(element, maskOptions);
</script>
</body>
</html>
