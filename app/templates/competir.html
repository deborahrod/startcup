<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
    crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <!-- jQuery primeiro -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" crossorigin="anonymous"></script>
<title>CriptoRace v3 - Envio de respostas</title>
<style>
  html,body{
    height:100%;
    margin:0;
    background:#000;
    overflow:hidden;
    font-family:"Courier New", Courier, monospace;
  }
  canvas#matrix{
    display:block;
    position:fixed;
    top:0;left:0;
    width:100vw;height:100vh;
    background:black;
      z-index: 0;
  }
  .credits{
    position:fixed;
    left:12px;bottom:12px;
    color:#0f0;opacity:0.55;
    font-size:12px;
  }
  .container-topo{
      position: relative;
      z-index: 10;
  }
  .porta-logo{
      width: 90%;
      height: 50%;
      overflow: hidden;
      margin: auto;
  }
  .porta-logo img{
      width: 100%;
      height: auto;
  }
  .porta-botoes button{
      margin-bottom: 50px;
  }
  form label{
      color:red;
  }
  h3{
      color: lawngreen;
  }
  #formResposta{
      visibility: hidden;
  }
  #entraJogo{
      margin-top: 10px;
  }
  #btnEntrar{
      visibility: hidden;
      display: none;
  }
</style>
</head>
<body>

<canvas id="matrix"></canvas>
<div class="credits">CriptoRace V3 - Quase nenhum direito reservado!</div>

<div class="container container-topo">
    <div class="porta-logo">
        <img src="../static/logo1.png" />
    </div>
    <h3>Envio de respostas</h3>
    <form id="formResposta">
      <div class="form-group">
        <label for="resposta">Sua resposta</label>
        <input type="text" class="form-control" id="resposta" >
      </div>

      <button type="submit" id="submitForm" class="btn btn-primary btn-block">Enviar resposta</button>

    </form>
    <div id="mensagem2"></div>
    <div id="entraJogo">
        <button type="button" class="btn btn-outline-danger btn-lg btn-block" onclick="vaiParaAHome()">Voltar √† home</button>
        <button type="button" class="btn btn-outline-danger btn-lg btn-block" onclick="vaiVerORanking()">Ver o ranking</button>
        <button type="button" id="btnEntrar" class="btn btn-outline-danger btn-lg btn-block" onclick="vaiParaLogin()">Entrar</button>
        <button type="button"  class="btn btn-outline-danger btn-lg btn-block" onclick="vaiSeInscrever()">Inscreva-se</button>
    </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('matrix');
  const ctx = canvas.getContext('2d');

  // par√¢metros fixos
  const speedMultiplier = 2.5;
  const densityMultiplier = 3.0;
  const globalAlpha = 0.8;
  let paused = false;

  const charset = (
    '„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé' +
    'ÊåÅ„Å§„ÅãÊåÅ„Åü„Å™„ÅÑ„Åã„ÅåÂïèÈ°å„Å†' +
    'ABCDEFGHIJKLMNOPQRSTUVWXYZ' +
    'abcdefghijklmnopqrstuvwxyz' +
    'Nensagens secretas CriptoRace' +
    '0123456789#666' +
    '!@#$%^&*()_+-=[]{}|;:,.<>/?'
  );

  let columns = [];
  let columnHeights = [];
  let fontSize = 18;

  function resize(){
    const DPR = window.devicePixelRatio || 1;
    canvas.width = Math.floor(window.innerWidth * DPR);
    canvas.height = Math.floor(window.innerHeight * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
    setupColumns();
  }
  window.addEventListener('resize', resize);

  function setupColumns(){
    const vw = Math.max(window.innerWidth,320);
    fontSize = Math.max(12, Math.round(vw / 80));
    ctx.font = fontSize + 'px monospace';
    const cols = Math.floor(window.innerWidth / fontSize);
    const effectiveCols = Math.max(2, Math.floor(cols * densityMultiplier));
    columns = new Array(effectiveCols);
    columnHeights = new Array(effectiveCols);
    for(let i=0;i<effectiveCols;i++){
      columns[i] = i * fontSize;
      columnHeights[i] = Math.floor(Math.random() * canvas.height / fontSize);
    }
  }

  const randChar = () => charset.charAt(Math.floor(Math.random() * charset.length));
  const greenColor = b => {
    const r = Math.floor(20 * (1 - b));
    const g = Math.floor(180 + 75 * b);
    const bl = Math.floor(20 * (1 - b));
    return `rgb(${r},${g},${bl})`;
  };

  let lastTime = 0;
  function step(time){
    if(!lastTime) lastTime = time;
    const dt = (time - lastTime)/1000;
    lastTime = time;
    if(!paused){
      ctx.fillStyle = `rgba(0,0,0,${0.08 / Math.max(0.08, globalAlpha)})`;
      ctx.fillRect(0,0,canvas.width,canvas.height);
      for(let i=0;i<columns.length;i++){
        const x = columns[i];
        const yLines = columnHeights[i];
        const yPx = yLines * fontSize;

        ctx.fillStyle = greenColor(1.0);
        ctx.globalAlpha = Math.min(1,globalAlpha);
        ctx.fillText(randChar(), x+2, yPx);

        const trailLen = 4;
        for(let t=1;t<=trailLen;t++){
          const yy = yPx - t*fontSize;
          if(yy<0) break;
          const bright = Math.max(0.15,1 - (t/(trailLen+1)));
          ctx.fillStyle = greenColor(bright);
          ctx.globalAlpha = Math.max(0.06, globalAlpha*(0.35*bright));
          ctx.fillText(randChar(), x+2, yy);
        }

        const baseSpeed = 5;
        const variance = (Math.random()*2 -1)*0.5;
        const deltaLines = (baseSpeed + variance) * speedMultiplier * dt;
        columnHeights[i] = yLines + deltaLines;
        if(columnHeights[i]*fontSize > canvas.height + 50 + Math.random()*500)
          columnHeights[i] = Math.random()*-30;
      }
      ctx.globalAlpha = 1.0;
    }
    requestAnimationFrame(step);
  }

  resize();
  ctx.fillStyle = 'black';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  requestAnimationFrame(step);

  // pausa autom√°tica se guia ficar oculta
  document.addEventListener('visibilitychange', () => {
    paused = document.hidden;
  });
})();
</script>
<script>
    $(document).ready(function () {
        //checando se o cabra j√° n√£o tem dados na sess√£o, indicando que j√° est√° cadastrado
        if (localStorage.getItem('candidato')) {
            const candidatoSessao = JSON.parse(localStorage.getItem('candidato'));
            //alert(candidatoSessao.idCandidato);
            $("#formResposta").show(); // esconde
            $("#formResposta").css({
                "visibility": "visible",
                "display": "block"
            });
          }else{
            $("#formResposta").hide(); // esconde
            $("#formResposta").css({
                "visibility": "hidden",
                "display": "none"
            });
            $("#btnEntrar").show(); // esconde
            $("#btnEntrar").css({
                "visibility": "visible",
                "display": "block"
            });
            $("#mensagem2").html('<div class="alert alert-danger">Candidato n√£o logado ou cadastrado. Volte √† Home caso n√£o esteja cadastrado ou clique em "Entrar" caso contr√°rio.</div>');
        }


        $("#formResposta").on("submit", function (event) {
            event.preventDefault();
            const candidato = JSON.parse(localStorage.getItem('candidato'));
            let resposta = {
                idCandidato: candidato.idCandidato,
                resposta: $("#resposta").val().trim()
            };
            if (resposta.resposta !== "") {
                console.log("Enviando resposta:", resposta);
                envia(resposta);
            }else{
                console.log("Abortando envio: campo vazio!");
                $("#mensagem2").html('<div class="alert alert-danger">Ops... t√° faltando uma resposnta, n√£o?!</div>');
                $('#resposta').focus();
            }
            return false;
        });
    });
    function envia(resposta) {
        $.ajax({
            url: "/respostas/buscarc",
            type: "POST",
            contentType: "application/json",  // enviando JSON
            dataType: "json",                 // esperando JSON
            data: JSON.stringify(resposta),
            success: function (response) {
                console.log("Resposta da API:", response);
                $("#mensagem2").html('');
                if (response && response.desafio && response.desafio.idDesafio > 0) {
                    if (response.desafio && response.desafio.status && response.desafio.status === "Ativo") {
                        if (response.duplicado && response.duplicado == "duplicado") {
                            $("#mensagem2").html('<div class="alert alert-danger">Ops... Parece que voc√™ j√° respondeu essa!ü§îü§î</div>');
                        } else {
                            if (response.desafio && response.desafio.pontuacao > 0) {
                                $("#mensagem2").html('<div class="alert alert-success">Uha!! Ganhou ' + response.desafio.pontuacao + ' pontos!üòäüòä</div>');
                            } else {
                                $("#mensagem2").html('<div class="alert alert-warning">Uha!! Acertou... mas... tu perdeu ' + response.desafio.pontuacao + ' pontos! Existem pegadinhas!! üòûüòû</div>');
                            }
                        }
                    }else{
                        $("#mensagem2").html('<div class="alert alert-danger">Ops... Esse desafio foi desativado! Algu√©m chegou na sua frente! ü§îü§î</div>');
                    }
                } else {
                    $("#mensagem2").html('<div class="alert alert-danger">Ops... errou! Nem passou perto!</div>');
                }
                $('#resposta').val('');
            },
            error: function (xhr) {
                console.error("Erro:", xhr);

                let erroMsg = "Erro ao enviar resposta. Em caso de d√∫vidas, procure o or√°culo.";
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    erroMsg = xhr.responseJSON.message;
                }

                $("#mensagem2").html('<div class="alert alert-danger">' + erroMsg + '</div>');
            }
        });
    }


    function vaiParaOJogo(agoranaoeh){
        //window.location.href = 'inscrevase.html';
        window.location.href = "{{ url_for('frontend.competir') }}";
    }
    function vaiParaAHome(){
        window.location.href = "{{ url_for('frontend.index') }}";
    }
    function vaiVerORanking(){
        window.location.href = "{{ url_for('frontend.ranking') }}";
    }
    function vaiParaLogin(){
        window.location.href = "{{ url_for('frontend.entrar') }}";
    }
    function vaiSeInscrever(){
        let outraDicaCritpRace = "cobra d'√°gua";
        window.location.href = "{{ url_for('frontend.inscrevase') }}";
    }
</script>
</body>
</html>
